# devenv

Vagrantを使用した開発環境

## これはなに？

私が個人的に使用している開発環境の定義リポジトリです。

## 設計思想

* どこでも簡単に同じ開発環境を作成できる。
* 新しい開発環境を簡単に定義できる。
* 開発環境を最新の状態に簡単にアップデートできる。
* 開発環境を再構築してもデータは消えない。
* シェルスクリプトベース

## 特徴

**複数の開発環境VMを作成**

vagrantのマルチマシン構成を使用して、開発するプロジェクトや機能に特化した開発環境VMを複数定義できます。

**開発環境VMに共通するBase Boxの作成**

全ての開発環境VMに共通する設定やパッケージを入れたBase Boxを作成できます。

Base Boxは既存のBoxから作成します。（packer等で作成する方法は、難しく時間がかかり更新に伴うメンテナンスが大変なため採用していません。）

Base Boxを使用することで各開発環境VMの作成時間が短くなり、リンククローンで容量も節約できます。

Base Boxは複数定義できます。

**Base Boxの更新機能**

付属のdevenvでBase Boxを簡単に更新できます。

作成済みのBase Boxを元に更新を行うので時間も短縮されます。

**ログインユーザーの自動作成**

ホストOSのユーザー名から自動的に開発環境VMへのログインユーザーを作成します。

公開鍵も自動的にインポートするのでSSHクライアントからすぐにログインできます。

通常の用途ではvagrantユーザーは使用しません。

**ストレージの追加機能**

システム用のストレージとは別にホームディレクトリ用のストレージを追加しています。

また任意の用途のストレージを簡単に追加できます。

**開発環境VMの更新機能**

付属のdevenvで開発環境VMを簡単に更新できます。

再プロビジョニングとBase Boxからの再作成による２つの更新機能があります。

Base Boxからの再作成による更新でも追加ストレージは保存されるため、ユーザーデータ等を消さずに開発環境VMを最新に更新することができます。

**開発環境VMの削除機能**

追加したストレージは保存しつつ、開発環境VMのみを削除します。

vagrant destroyではアタッチされたストレージは全て削除されるので、追加ストレージをデタッチしてから削除しています。

**シェルスクリプトベースのプロビジョニング**

シェルベースでプロビジョニングコードを記述しやすくするための簡易関数が使用できます。

## 定義済み開発環境

**default**

汎用的な目的で使う仮想マシン。通常使用したり簡単な実験を行う。

**dns**

[開発用のローカルDNSサーバー](https://github.com/ko1nksm/devdns)を起動している。

ダイナミックDNSによりホストを登録できる。

**docker**

dockerコンテナの実験や作成済みコンテナを動かす場所。

起動したコンテナのホスト名/IPアドレスは[自動的にdnsに登録](https://github.com/ko1nksm/docker-nsupdate-plugin)される。

補足 dockerネットワークは172.30.0.0/24に設定され、ホストOS上で適切なルーティングをすることでコンテナに直接接続できる。

**proxy**

ホストOSの外から各ゲストOSに接続するためのhttpプロキシサーバー

**test**

ちょっとしたテスト用

## 使用方法

**Base Boxのビルド**

すでにBase Boxがビルド済みの場合はアップデートされます。(再プロビジョニング)

```
./devenv build debian/jessie64
```

**Base Boxへのssh**

テスト用にBase Boxにログインできます。

```
./devenv ssh debian/jessie64
```

**開発環境VMの作成**

vagrant upしてからhaltを行います。

```
./devenv create default
```

**開発環境VMの更新**

再プロビジョニングを行います。開発環境環境VMの起動状態は変更しません。

```
./devenv upgrade default
```

**開発環境VMの再作成**

開発環境VMを削除してからBase Boxから再作成します。追加ストレージは保存されます。

```
./devenv upgrade default -r
```

**開発環境VMの削除**

開発環境VMを削除します。追加ストレージは保存されます。

```
./devenv remove default
```

## ネットワーク

VMのネットワーク (\*.local.int) として192.168.33.0/24を使用する。
名前解決はローカルPCにインストールしたunboundによって解決する

dockerコンテナのネットワーク (\*.dev.int) として172.30.0.0/24使用している。
172.30.0.0/24は192.168.33.11 (docker VM) にルーティングされる。
名前解決はdns.local.int (192.168.33.12) によって解決する。

### OSX設定

ルーティング周り

```
sudo route -n add 172.30.0.0/24 192.168.33.11
sudo route -n delete 172.30.0.0/24 192.168.33.11
netstat -rn
```

unbound周り

```
/usr/local/etc/unbound/unbound.conf を設定
sudo brew services start unbound
```

## ライセンス

* vagrant-dev(別リポジトリ)部分は vagrant-devのライセンス(MIT License)に準じます。
* その他のファイルはパブリックドメイン扱いです。
